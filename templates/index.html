<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Summarizer, Translator & Q&A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden">
            <div class="gradient-bg p-6 text-center">
                <h1 class="text-3xl font-bold text-white">PDF Summarizer, Translator & Q&A</h1>
                <p class="text-white mt-2">Upload a PDF to summarize, translate, or ask questions!</p>
            </div>

            <div class="p-6">
                <form class="space-y-4" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                    <div class="flex items-center gap-4">
                        <input type="file" name="file" accept=".pdf" required class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 flex-1">
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-full hover:bg-blue-700 transition">Upload & Summarize</button>
                    </div>
                </form>

                <div id="loading" class="hidden flex items-center justify-center mt-4">
                    <div class="spinner"></div>
                    <p class="ml-2 text-gray-600">Processing your PDF...</p>
                </div>

                {% if error %}
                <div class="mt-4 p-4 bg-red-100 text-red-700 rounded-lg">{{ error }}</div>
                {% endif %}

                {% if summary %}
                <div class="mt-6">
                    <div class="flex border-b border-gray-200">
                        <button class="tab px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600" onclick="switchTab('summary')">Summary</button>
                        <button class="tab px-4 py-2 font-medium text-gray-600" onclick="switchTab('qa')">Q&A</button>
                        <button class="tab px-4 py-2 font-medium text-gray-600" onclick="switchTab('translation')">Translation</button>
                    </div>

                    <!-- Summary Tab -->
                    <div id="summary-tab" class="tab-content mt-4">
                        <h2 class="text-xl font-semibold text-gray-800">Summary</h2>
                        <div class="mt-2 p-4 bg-gray-50 rounded-lg text-gray-700">{{ summary }}</div>
                        {% if filename %}
                        <div class="mt-4 flex gap-4">
                            <a href="{{ url_for('download_file', filename=filename) }}" class="bg-green-600 text-white py-2 px-4 rounded-full hover:bg-green-700 transition">Download Summary</a>
                            <button onclick="showTranslation()" class="bg-purple-600 text-white py-2 px-4 rounded-full hover:bg-purple-700 transition">Translate Summary</button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Q&A Tab -->
                    <div id="qa-tab" class="tab-content hidden mt-4">
                        <h2 class="text-xl font-semibold text-gray-800">Ask a Question</h2>
                        <div class="mt-2">
                            <textarea id="question-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Ask a question about the PDF content..."></textarea>
                            <button onclick="askQuestion()" class="mt-2 bg-blue-600 text-white py-2 px-4 rounded-full hover:bg-blue-700 transition">Submit Question</button>
                        </div>
                        <div id="qa-loading" class="hidden flex items-center justify-center mt-4">
                            <div class="spinner"></div>
                            <p class="ml-2 text-gray-600">Fetching answer...</p>
                        </div>
                        <div id="qa-error" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg"></div>
                        <div id="qa-answer" class="hidden mt-4 p-4 bg-blue-50 text-blue-800 rounded-lg"></div>
                    </div>

                    <!-- Translation Tab -->
                    <div id="translation-tab" class="tab-content hidden mt-4">
                        <h2 class="text-xl font-semibold text-gray-800">Translate Summary</h2>
                        <p class="text-gray-600 mt-1">Translate the summary from English to your selected language.</p>
                        <div class="mt-4 flex flex-wrap gap-4 items-center">
                            <select id="target-language" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                {% for id, lang in languages.items() %}
                                    {% if id != 0 %}
                                    <option value="{{ id }}">{{ lang.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button id="translate-button" onclick="translateSummary()" class="bg-purple-600 text-white py-2 px-4 rounded-full hover:bg-purple-700 transition">Translate</button>
                        </div>
                        <div id="translation-loading" class="hidden flex items-center justify-center mt-4">
                            <div class="spinner"></div>
                            <p class="ml-2 text-gray-600">Translating your summary...</p>
                        </div>
                        <div id="translation-error" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg"></div>
                        <div id="translation-success" class="hidden mt-4 p-4 bg-green-100 text-green-700 rounded-lg"></div>
                        <div id="translated-content-container" class="hidden mt-4">
                            <h3 class="text-lg font-medium text-gray-800">Translated Text</h3>
                            <div id="translated-content" class="mt-2 p-4 bg-gray-50 rounded-lg text-gray-700"></div>
                            <button onclick="downloadTranslation()" class="mt-2 bg-orange-600 text-white py-2 px-4 rounded-full hover:bg-orange-700 transition">Download Translation</button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-600');
            });
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        }

        function showTranslation() {
            switchTab('translation');
        }

        function askQuestion() {
            const question = document.getElementById('question-input').value.trim();
            if (!question) {
                document.getElementById('qa-error').innerText = 'Please enter a question.';
                document.getElementById('qa-error').classList.remove('hidden');
                return;
            }

            document.getElementById('qa-loading').classList.remove('hidden');
            document.getElementById('qa-error').classList.add('hidden');
            document.getElementById('qa-answer').classList.add('hidden');

            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('qa-loading').classList.add('hidden');
                if (data.error) {
                    document.getElementById('qa-error').innerText = data.error;
                    document.getElementById('qa-error').classList.remove('hidden');
                } else {
                    document.getElementById('qa-answer').innerText = data.answer;
                    document.getElementById('qa-answer').classList.remove('hidden');
                }
            })
            .catch(error => {
                document.getElementById('qa-loading').classList.add('hidden');
                document.getElementById('qa-error').innerText = 'Error: ' + error.message;
                document.getElementById('qa-error').classList.remove('hidden');
            });
        }

        function translateSummary() {
            const summary = document.querySelector('#summary-tab .bg-gray-50').innerText;
            const targetLang = document.getElementById('target-language').value;

            document.getElementById('translation-loading').classList.remove('hidden');
            document.getElementById('translated-content-container').classList.add('hidden');
            document.getElementById('translation-error').classList.add('hidden');
            document.getElementById('translation-success').classList.add('hidden');

            fetch('/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    target_language: parseInt(targetLang),
                    content: summary
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('translation-loading').classList.add('hidden');
                if (data.error) {
                    document.getElementById('translation-error').innerText = data.error;
                    document.getElementById('translation-error').classList.remove('hidden');
                } else if (data.translated_content) {
                    document.getElementById('translated-content').innerText = data.translated_content;
                    document.getElementById('translated-content-container').classList.remove('hidden');
                    document.getElementById('translation-success').innerText = 'Translation completed successfully!';
                    document.getElementById('translation-success').classList.remove('hidden');
                } else {
                    document.getElementById('translation-error').innerText = data.message || 'Translation failed';
                    document.getElementById('translation-error').classList.remove('hidden');
                }
            })
            .catch(error => {
                document.getElementById('translation-loading').classList.add('hidden');
                document.getElementById('translation-error').innerText = 'Error: ' + error.message;
                document.getElementById('translation-error').classList.remove('hidden');
            });
        }

        function downloadTranslation() {
            const translatedText = document.getElementById('translated-content').innerText;
            const targetLangSelect = document.getElementById('target-language');
            const targetLangName = targetLangSelect.options[targetLangSelect.selectedIndex].text;

            const blob = new Blob([translatedText], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `translation_${targetLangName.toLowerCase()}_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>